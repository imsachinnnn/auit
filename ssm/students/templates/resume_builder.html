{% extends 'stddash.html' %}
{% load static %}

{% block header_actions %}
<a href="{% url 'student_dashboard' %}" class="action-btn btn-outline" style="margin-right: 10px;">
    ‚¨ÖÔ∏è Back to Dashboard
</a>
<a href="{% url 'student_logout' %}" class="action-btn btn-danger">Logout</a>
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/resume_builder.css' %}">

<div class="rb-header">
    <h2 style="margin:0; color:var(--accent-color);">Resume Builder</h2>
    <div class="header-actions">
        <!-- Status Indicator (Hidden by default) -->
        <span id="ai-status-indicator" class="status-time" style="display:none; font-size:0.85em; color:green;">
            ‚ú® AI Resume Active
        </span>

        <!-- Clear AI Button -->
        <button id="ai-clear-btn" class="btn-secondary-outline" style="display:none;">
            ‚úñ Clear AI Data
        </button>

        <!-- Generate AI Button -->
        <a href="#" id="ai-generate-btn" class="action-btn btn-ai" style="font-size: 0.9em;">
            <span class="emoji">‚ú®</span> Enhance with AI
        </a>

        <a href="{% url 'generate_resume_pdf' %}" class="action-btn btn-primary">
            <span class="emoji">üìÑ</span> Download PDF
        </a>
    </div>
</div>

<!-- Last Generated Status Box -->
<div id="ai-status-box" class="ai-status-box" style="display:none;">
    <div>
        <strong>Professional Resume Generated</strong> on <span id="generated-time"></span>
        <div style="font-size:0.85em; margin-top:4px;">
            Contains <span id="versions-info">enhanced projects and skills</span>.
        </div>
    </div>
</div>

<div class="content-grid">
    <!-- Skills Section -->
    <div class="card">
        <h2 class="card-title">
            <span>üõ†Ô∏è</span> Technical Skills
        </h2>

        <form method="post" class="resume-form-section">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Skill Name</label>
                <input type="text" name="skill_name" class="form-control" placeholder="e.g. Python, Java, Leadership"
                    required>
            </div>
            <div class="form-group">
                <label class="form-label">Proficiency</label>
                <select name="proficiency" class="form-control">
                    {% for value, text in skill_form.fields.proficiency.choices %}
                    <option value="{{ value }}">{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 25px;"> <!-- Increased gap -->
                <button type="submit" name="add_skill" class="action-btn btn-primary" style="width:100%">+ Add
                    Skill</button>
            </div>
        </form>

        <div class="skills-list">
            {% for skill in skills %}
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-title">{{ skill.skill_name }}</div>
                    <div class="list-item-subtitle">{{ skill.proficiency }}</div>
                </div>
                <form method="post" style="margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="skill_id" value="{{ skill.id }}">
                    <button type="submit" name="delete_skill" class="delete-btn" title="Delete">üóëÔ∏è</button>
                </form>
            </div>
            {% empty %}
            <p style="color: var(--text-secondary); text-align: center; font-style: italic; padding: 15px;">No skills
                added yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Projects Section -->
    <div class="card">
        <h2 class="card-title"><span>üöÄ</span> Academic Projects</h2>

        <form method="post" class="resume-form-section">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Project Title</label>
                <input type="text" name="title" class="form-control" placeholder="Project Name" required>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3"
                    placeholder="Briefly describe what you built..." required></textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <input type="text" name="role" class="form-control" placeholder="e.g. Developer">
                </div>
                <div class="form-group">
                    <label class="form-label">Technologies Used</label>
                    <input type="text" name="technologies" class="form-control" placeholder="e.g. Django">
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 25px;"> <!-- Increased gap -->
                <button type="submit" name="add_project" class="action-btn btn-primary" style="width:100%">+ Add
                    Project</button>
            </div>
        </form>

        <div class="projects-list">
            {% for project in projects %}
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-title">{{ project.title }} <span
                            style="font-weight:normal; color:var(--text-secondary);">({{ project.role }})</span></div>
                    <div class="list-item-subtitle">{{ project.technologies }}</div>
                    <div style="font-size: 0.85em; margin-top: 4px; color: var(--text-primary);">
                        {{project.description|truncatechars:60 }}</div>
                </div>
                <form method="post" style="margin:0;">
                    {% csrf_token %}
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <button type="submit" name="delete_project" class="delete-btn" title="Delete">üóëÔ∏è</button>
                </form>
            </div>
            {% empty %}
            <p style="color: var(--text-secondary); text-align: center; font-style: italic; padding: 15px;">No projects
                added yet.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- SweetAlert2 for Premium Alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        checkAIStatus();
    });

    function checkAIStatus() {
        fetch('{% url "ai_resume_status" %}')
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    document.getElementById('ai-status-box').style.display = 'flex';
                    document.getElementById('ai-clear-btn').style.display = 'inline-block';
                    document.getElementById('generated-time').innerText = new Date(data.generated_at).toLocaleString();
                    document.getElementById('ai-generate-btn').innerHTML = '<span class="emoji">üîÑ</span> Regenerate AI';
                } else {
                    document.getElementById('ai-status-box').style.display = 'none';
                    document.getElementById('ai-clear-btn').style.display = 'none';
                    document.getElementById('ai-generate-btn').innerHTML = '<span class="emoji">‚ú®</span> Enhance with AI';
                }
            });
    }

    // Clear AI Data
    document.getElementById('ai-clear-btn').addEventListener('click', function () {
        Swal.fire({
            title: 'Clear AI Data?',
            text: "This will remove the enhanced version and revert to your raw manual data.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Yes, Clear it'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('{% url "clear_ai_resume" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                    .then(res => res.json())
                    .then(data => {
                        checkAIStatus();
                        Swal.fire('Cleared', 'AI resume data has been removed.', 'success');
                    });
            }
        });
    });

    // Generate AI Resume
    document.getElementById('ai-generate-btn').addEventListener('click', function (e) {
        e.preventDefault();
        const btn = this;
        const originalText = btn.innerHTML;

        Swal.fire({
            title: 'Enhance with AI?',
            text: "AI will analyze your profile to create a professional, ATS-optimized resume. This works best if you have added at least one project or skill.",
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#6f42c1',
            confirmButtonText: 'Yes, Enhance it! ‚ú®'
        }).then((result) => {
            if (result.isConfirmed) {

                // Show Loading
                btn.innerHTML = '<span class="emoji">‚è≥</span> Magic in progress...';
                btn.style.opacity = '0.7';
                btn.style.pointerEvents = 'none';

                Swal.fire({
                    title: 'Crafting Your Masterpiece...',
                    html: 'Consulting top career strategists...',
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                fetch('{% url "ai_generate_resume" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                    .then(response => response.json())
                    .then(data => {
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';

                        if (data.error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Generation Failed',
                                text: data.message || data.error,
                            });
                        } else {
                            checkAIStatus();
                            Swal.fire({
                                title: '‚ú® Resume Enhanced!',
                                text: 'Your resume has been professionally rewritten. Click download to see the result.',
                                icon: 'success',
                                confirmButtonText: 'Download PDF',
                                confirmButtonColor: '#28a745'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "{% url 'generate_resume_pdf' %}";
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                        Swal.fire('Error', 'Network request failed. Please try again.', 'error');
                    });
            }
        });
    });
</script>
{% endblock %}